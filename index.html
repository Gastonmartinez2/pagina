<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NutriFit Guide: Tu Asistente Personal para Comidas Saludables</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #d4f4e2 0%, #e8f5e9 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        header {
            text-align: center;
            padding: 40px 20px;
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
        }
        h1 {
            font-size: 2.8em;
            margin: 0;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
        .welcome {
            font-style: italic;
            font-size: 1.2em;
            margin-top: 10px;
        }
        main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            flex: 1;
        }
        h2, h3 {
            color: #2f855a;
            font-weight: 600;
        }
        section {
            background: white;
            padding: 30px;
            margin-bottom: 30px;
            border-radius: 15px;
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        section:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
        }
        form {
            display: grid;
            gap: 20px;
        }
        label {
            font-weight: 600;
            color: #4a5568;
            display: flex;
            align-items: center;
        }
        label::before {
            content: 'üìå ';
            margin-right: 5px;
        }
        input, select, button {
            padding: 12px;
            border: 1px solid #cbd5e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        input:focus, select:focus {
            border-color: #48bb78;
            box-shadow: 0 0 5px rgba(72,187,120,0.5);
            outline: none;
        }
        button {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            cursor: pointer;
            font-weight: 600;
            border: none;
            transition: background 0.3s, transform 0.2s;
        }
        button:hover {
            background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
            transform: scale(1.02);
        }
        #macros {
            background: #f0fff4;
            border-left: 5px solid #48bb78;
        }
        #macros p {
            margin: 10px 0;
            font-size: 1.1em;
        }
        #user-summary {
            background: #ebf8ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        #meal-result {
            margin-top: 20px;
            padding: 15px;
            background: #f0fff4;
            border-radius: 8px;
            border: 1px solid #c6f6d5;
        }
        .emoji {
            font-size: 1.2em;
            margin-right: 5px;
        }
        #flavor-choice {
            display: none;
        }
        .macro-group {
            display: flex;
            gap: 20px;
        }
        .macro-group > div {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        footer {
            text-align: center;
            padding: 20px;
            color: #718096;
            font-size: 0.9em;
            background: #f7fafc;
            border-top: 1px solid #e2e8f0;
        }
        #meal-ideas {
            display: none;
        }
        #meal-ideas ul {
            list-style-type: disc;
            padding-left: 20px;
        }
    </style>
</head>
<body>
    <header>
        <h1>¬°Bienvenido a NutriFit Guide! ü•óüçé</h1>
        <p class="welcome">Tu asistente profesional para planificar comidas equilibradas, personalizadas seg√∫n tus objetivos nutricionales. ¬°Descubre opciones saludables y deliciosas!</p>
    </header>

    <main>
        <section id="user-input">
            <h2>Datos Personales üìä</h2>
            <p>Ingresa tus detalles para calcular macros precisos y personalizados. Todos los campos son requeridos para un c√°lculo √≥ptimo.</p>
            <form>
                <label>Peso (kg):</label>
                <input type="number" id="weight" required min="1">

                <label>Altura (cm):</label>
                <input type="number" id="height" required min="1">

                <label>Edad (a√±os):</label>
                <input type="number" id="age" required min="1">

                <label>G√©nero:</label>
                <select id="gender" required>
                    <option value="male">Masculino</option>
                    <option value="female">Femenino</option>
                </select>

                <label>Objetivo:</label>
                <select id="objective" required>
                    <option value="loss">P√©rdida de peso/grasa</option>
                    <option value="maintenance">Mantenimiento</option>
                    <option value="gain">Aumento de masa muscular</option>
                </select>

                <label>Nivel de Actividad F√≠sica (d√≠as por semana):</label>
                <input type="number" id="activity-days" required min="0" max="7">

                <label>Duraci√≥n por sesi√≥n (minutos):</label>
                <input type="number" id="activity-duration" required min="0">

                <label>Hora del d√≠a para actividad:</label>
                <select id="activity-time">
                    <option value="morning">Ma√±ana</option>
                    <option value="afternoon">Tarde</option>
                    <option value="evening">Noche</option>
                    <option value="any">Cualquiera</option>
                </select>

                <label>¬øRealizas caminatas?</label>
                <select id="walking" required>
                    <option value="yes">S√≠</option>
                    <option value="no">No</option>
                </select>

                <label>¬øPrefieres 4 o 5 comidas al d√≠a?</label>
                <select id="meals-per-day" required>
                    <option value="4">4 comidas</option>
                    <option value="5">5 comidas</option>
                </select>

                <button type="button" onclick="calculateMacros()">Calcular Macros Diarios</button>
            </form>
        </section>

        <section id="macros" style="display: none;">
            <h2>Resumen de Tus Datos Personales üìã</h2>
            <div id="user-summary"></div>

            <h3>Tus Macros Diarios Aproximados üçé</h3>
            <p>Basado en tus datos, aqu√≠ est√°n tus requerimientos diarios estimados. Recuerda consultar a un profesional para ajustes precisos.</p>
            <p>Prote√≠nas: <span id="protein">0</span> g</p>
            <p>Carbohidratos: <span id="carb">0</span> g</p>
            <p>Grasas Saludables: <span id="fat">0</span> g</p>
            <p>Fibra: <span id="fiber">0</span> g</p>
            <p><em>Nota: Estos c√°lculos consideran tu peso, objetivo y actividad. Usa el planificador para distribuir en comidas.</em></p>
        </section>

        <section id="meal-planner">
            <h2>Planificador de Comidas ü•ò</h2>
            <p>Selecciona el tipo de comida y personaliza tus opciones. Puedes elegir hasta 2 fuentes de carbohidratos y fibra (la primera es obligatoria, la segunda opcional). Las cantidades se distribuir√°n con m√°s peso en el principal (primero seleccionado). Para frutas, se sugieren unidades enteras. Todas las cantidades se dan en peso crudo, con macros ajustados. Cantidades redondeadas para facilitar el pesaje (a m√∫ltiplos de 5 o 10).</p>

            <label>Tipo de Comida:</label>
            <select id="meal-type" onchange="updateFlavorChoice()">
                <option value="">Selecciona...</option>
                <option value="breakfast">Desayuno</option>
                <option value="colacion">Colaci√≥n</option>
                <option value="snack">Merienda</option>
                <option value="lunch">Almuerzo</option>
                <option value="dinner">Cena</option>
            </select>

            <div id="flavor-choice">
                <label>Preferencia:</label>
                <select id="flavor" onchange="updateOptions()">
                    <option value="salty">Salado</option>
                    <option value="sweet">Dulce</option>
                </select>
            </div>

            <label>Fuente de Prote√≠na:</label>
            <select id="protein-source"></select>

            <div class="macro-group">
                <div>
                    <label>Carbohidrato 1 (principal, obligatorio):</label>
                    <select id="carb-source1" required></select>
                </div>
                <div>
                    <label>Carbohidrato 2 (opcional):</label>
                    <select id="carb-source2"></select>
                </div>
            </div>

            <label>Fuente de Grasa Saludable:</label>
            <select id="fat-source"></select>

            <div class="macro-group">
                <div>
                    <label>Fibra 1 (principal, obligatoria):</label>
                    <select id="fiber-source1" required></select>
                </div>
                <div>
                    <label>Fibra 2 (opcional):</label>
                    <select id="fiber-source2"></select>
                </div>
            </div>

            <button type="button" onclick="calculateMeal()">Calcular Cantidades para esta Comida</button>

            <div id="meal-result"></div>
        </section>

        <section id="meal-ideas">
            <h2 id="ideas-title">Ideas de Comidas Saludables üçΩÔ∏è</h2>
            <p>Aqu√≠ hay algunas ideas integrando alimentos en cantidades aproximadas basadas en tus macros. Ajusta seg√∫n tus preferencias. Para desayunos y meriendas, considera infusiones como caf√©, t√©, mate, mate cocido o leche.</p>
            <ul id="ideas-list"></ul>
        </section>
    </main>

    <footer>
        ¬© 2023 NutriFit Guide | Dise√±ado para h√°bitos saludables | Consulta siempre a un nutricionista.
    </footer>

    <script>
        // Protein sources - Added new
        const proteinSources = {
            common: [
                {name: 'Carne magra (cruda)', prot: 21, unit: '100g', unitName: 'g'}, 
                {name: 'Carne de cerdo (cruda)', prot: 21, unit: '100g', unitName: 'g'},
                {name: 'Pollo muslo (crudo)', prot: 18, unit: '100g', unitName: 'g'}, 
                {name: 'Pechuga de pollo (cruda)', prot: 22, unit: '100g', unitName: 'g'}, 
                {name: 'Huevos', prot: 6, unit: 'unit', unitName: 'huevos'},
                {name: 'Pescado (at√∫n/caballa/rio, crudo)', prot: 24, unit: '100g', unitName: 'g'},
                {name: 'Tofu', prot: 8, unit: '100g', unitName: 'g'},
                {name: 'Queso cottage', prot: 11, unit: '100g', unitName: 'g'}
            ],
            breakfastSnack: [
                {name: 'Yogur griego', prot: 10, unit: '100g', unitName: 'g'}, 
                {name: 'Batido de prote√≠na', prot: 23.5, unit: 'unit', unitName: 'batido'},
                {name: 'Panqueques de prote√≠na', prot: 20, unit: 'unit', unitName: 'porci√≥n'},
                {name: 'Barritas de prote√≠na', prot: 15, unit: 'unit', unitName: 'barrita'} 
            ]
        };

        // Carb sources - With isFruit for unit display
        const carbSources = [
            {name: 'Arroz blanco (crudo)', carb: 78, unit: '100g', unitName: 'g', type: 'salty', isFruit: false},
            {name: 'Arroz integral (crudo)', carb: 74, unit: '100g', unitName: 'g', type: 'salty', isFruit: false},
            {name: 'Fideos (crudos)', carb: 75, unit: '100g', unitName: 'g', type: 'salty', isFruit: false},
            {name: 'Avena arrollada (cruda)', carb: 66, unit: '100g', unitName: 'g', type: 'both', isFruit: false},
            {name: 'Harina de trigo', carb: 76, unit: '100g', unitName: 'g', type: 'salty', isFruit: false},
            {name: 'Polenta (cruda)', carb: 80, unit: '100g', unitName: 'g', type: 'salty', isFruit: false},
            {name: 'Papa (cruda)', carb: 17, unit: '100g', unitName: 'g', type: 'salty', isFruit: false},
            {name: 'Batata (cruda)', carb: 20, unit: '100g', unitName: 'g', type: 'salty', isFruit: false},
            {name: 'Mandioca (cruda)', carb: 38, unit: '100g', unitName: 'g', type: 'salty', isFruit: false},
            {name: 'Zapallo (crudo)', carb: 7, unit: '100g', unitName: 'g', type: 'salty', isFruit: false},
            {name: 'Pan blanco', carb: 49, unit: '100g', unitName: 'g', type: 'both', isFruit: false},
            {name: 'Pan integral', carb: 43, unit: '100g', unitName: 'g', type: 'both', isFruit: false},
            {name: 'Pan de molde', carb: 46, unit: '100g', unitName: 'g', type: 'both', isFruit: false},
            {name: 'Tortilla de trigo', carb: 53, unit: '100g', unitName: 'g', type: 'salty', isFruit: false},
            {name: 'Galletas de arroz', carb: 81, unit: '100g', unitName: 'g', type: 'salty', isFruit: false},
            {name: 'Banana', carb: 23, unit: '100g', unitName: 'bananas (120g c/u approx)', type: 'sweet', isFruit: true, avgSize: 120},
            {name: 'Manzana', carb: 14, unit: '100g', unitName: 'manzanas (150g c/u approx)', type: 'sweet', isFruit: true, avgSize: 150},
            {name: 'Lentejas (crudas)', carb: 58, unit: '100g', unitName: 'g', type: 'salty', isFruit: false},
            {name: 'Garbanzos (crudos)', carb: 61, unit: '100g', unitName: 'g', type: 'salty', isFruit: false},
            {name: 'Porotos (crudos)', carb: 62, unit: '100g', unitName: 'g', type: 'salty', isFruit: false},
            {name: 'Quinua (cruda)', carb: 64, unit: '100g', unitName: 'g', type: 'salty', isFruit: false},
            {name: 'Pasta (cruda)', carb: 75, unit: '100g', unitName: 'g', type: 'salty', isFruit: false},
            {name: 'Ma√≠z (crudo)', carb: 74, unit: '100g', unitName: 'g', type: 'salty', isFruit: false},
            {name: 'Kiwi', carb: 15, unit: '100g', unitName: 'kiwis (75g c/u approx)', type: 'sweet', isFruit: true, avgSize: 75},
            {name: 'Uvas', carb: 18, unit: '100g', unitName: 'g', type: 'sweet', isFruit: false}
        ];

        // Fat sources
        const fatSources = [
            {name: 'Aceite (1 cda ~10g grasa)', fat: 100, unit: '100g', unitName: 'g'},
            {name: 'Palta', fat: 15, unit: '100g', unitName: 'g'},
            {name: 'Aceitunas', fat: 13, unit: '100g', unitName: 'g'},
            {name: 'Almendras', fat: 50, unit: '100g', unitName: 'g'},
            {name: 'Nueces', fat: 65, unit: '100g', unitName: 'g'},
            {name: 'Man√≠', fat: 49, unit: '100g', unitName: 'g'},
            {name: 'Casta√±as de caj√∫', fat: 44, unit: '100g', unitName: 'g'},
            {name: 'Ch√≠a', fat: 31, unit: '100g', unitName: 'g'},
            {name: 'Lino', fat: 42, unit: '100g', unitName: 'g'},
            {name: 'S√©samo', fat: 50, unit: '100g', unitName: 'g'},
            {name: 'Girasol', fat: 50, unit: '100g', unitName: 'g'},
            {name: 'Mantequilla de man√≠', fat: 50, unit: '100g', unitName: 'g'},
            {name: 'Coco rallado', fat: 33, unit: '100g', unitName: 'g'}
        ];

        // Fiber sources - Added fruits nuts as general option
        const fiberSources = [
            {name: 'Tomate', fiber: 1.2, unit: '100g', unitName: 'g', type: 'salty', isFruit: false},
            {name: 'Lechuga', fiber: 1.3, unit: '100g', unitName: 'g', type: 'salty', isFruit: false},
            {name: 'Br√≥coli', fiber: 2.6, unit: '100g', unitName: 'g', type: 'salty', isFruit: false},
            {name: 'Espinacas', fiber: 2.2, unit: '100g', unitName: 'g', type: 'salty', isFruit: false},
            {name: 'Zanahoria', fiber: 2.8, unit: '100g', unitName: 'g', type: 'salty', isFruit: false},
            {name: 'Pepino', fiber: 0.5, unit: '100g', unitName: 'g', type: 'salty', isFruit: false},
            {name: 'Pimiento', fiber: 1.7, unit: '100g', unitName: 'g', type: 'salty', isFruit: false},
            {name: 'Zapallo', fiber: 1.0, unit: '100g', unitName: 'g', type: 'salty', isFruit: false},
            {name: 'Ensalada mixta (lechuga + tomate + pepino)', fiber: 1.0, unit: '100g', unitName: 'g', type: 'salty', isFruit: false},
            {name: 'Banana (postre)', fiber: 2.6, unit: '100g', unitName: 'bananas (120g c/u approx)', type: 'sweet', isFruit: true, avgSize: 120},
            {name: 'Manzana (postre)', fiber: 2.4, unit: '100g', unitName: 'manzanas (150g c/u approx)', type: 'sweet', isFruit: true, avgSize: 150},
            {name: 'Naranja (postre)', fiber: 2.4, unit: '100g', unitName: 'naranjas (200g c/u approx)', type: 'sweet', isFruit: true, avgSize: 200},
            {name: 'Fresa (postre)', fiber: 2.0, unit: '100g', unitName: 'fresas (15g c/u approx)', type: 'sweet', isFruit: true, avgSize: 15},
            {name: 'Pera (postre)', fiber: 3.1, unit: '100g', unitName: 'peras (150g c/u approx)', type: 'sweet', isFruit: true, avgSize: 150},
            {name: 'Coliflor', fiber: 2.0, unit: '100g', unitName: 'g', type: 'salty', isFruit: false},
            {name: 'Remolacha', fiber: 2.8, unit: '100g', unitName: 'g', type: 'salty', isFruit: false},
            {name: 'Kiwi (postre)', fiber: 3.0, unit: '100g', unitName: 'kiwis (75g c/u approx)', type: 'sweet', isFruit: true, avgSize: 75},
            {name: 'Pi√±a (postre)', fiber: 1.4, unit: '100g', unitName: 'pi√±as (porciones de 150g approx)', type: 'sweet', isFruit: true, avgSize: 150},
            {name: 'Frutos secos (mezcla general)', fiber: 8, unit: '100g', unitName: 'g', type: 'both', isFruit: false}
        ];

        // Populate selects
        function populateSelect(selectId, sources) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">Selecciona...</option>';
            sources.forEach(source => {
                const option = document.createElement('option');
                option.value = JSON.stringify(source);
                option.textContent = source.name;
                select.appendChild(option);
            });
        }

        populateSelect('fat-source', fatSources);

        // Update flavor choice visibility
        function updateFlavorChoice() {
            const mealType = document.getElementById('meal-type').value;
            const flavorDiv = document.getElementById('flavor-choice');
            const mealsPerDay = parseInt(document.getElementById('meals-per-day').value);
            const colacionOption = document.querySelector('#meal-type option[value="colacion"]');
            if (mealsPerDay === 5) {
                if (!colacionOption) {
                    const option = document.createElement('option');
                    option.value = 'colacion';
                    option.textContent = 'Colaci√≥n';
                    document.getElementById('meal-type').appendChild(option);
                }
            } else {
                if (colacionOption) colacionOption.remove();
            }
            if (mealType === 'breakfast' || mealType === 'snack' || mealType === 'colacion') {
                flavorDiv.style.display = 'block';
            } else {
                flavorDiv.style.display = 'none';
            }
            updateOptions();
        }

        // Update options based on meal type and flavor
        function updateOptions() {
            const mealType = document.getElementById('meal-type').value;
            const flavor = document.getElementById('flavor').value || 'salty';

            // Proteins
            let proteins = proteinSources.common;
            if (mealType === 'breakfast' || mealType === 'snack' || mealType === 'colacion') {
                proteins = proteins.concat(proteinSources.breakfastSnack);
            }
            populateSelect('protein-source', proteins);

            // Carbs
            let carbFilter = carbSources;
            if (mealType === 'lunch' || mealType === 'dinner') {
                carbFilter = carbSources.filter(c => c.type === 'salty' || c.type === 'both');
            } else if (flavor === 'sweet') {
                carbFilter = carbSources.filter(c => c.type === 'sweet' || c.type === 'both');
            } else {
                carbFilter = carbSources.filter(c => c.type === 'salty' || c.type === 'both');
            }
            populateSelect('carb-source1', carbFilter);
            populateSelect('carb-source2', carbFilter);

            // Fiber
            let fiberFilter = fiberSources;
            if (mealType === 'lunch' || mealType === 'dinner') {
                fiberFilter = fiberSources;
            } else if (flavor === 'sweet') {
                fiberFilter = fiberSources.filter(f => f.type === 'sweet');
            } else {
                fiberFilter = fiberSources.filter(f => f.type === 'salty');
            }
            populateSelect('fiber-source1', fiberFilter);
            populateSelect('fiber-source2', fiberFilter);
        }

        function calculateBMR(weight, height, age, gender) {
            if (gender === 'male') {
                return 88.362 + (13.397 * weight) + (4.799 * height) - (5.677 * age);
            } else {
                return 447.593 + (9.247 * weight) + (3.098 * height) - (4.330 * age);
            }
        }

        function getActivityMultiplier(days, duration) {
            const intensity = (days * duration) / 7;
            if (intensity < 20) return 1.2;
            if (intensity < 40) return 1.375;
            if (intensity < 60) return 1.55;
            if (intensity < 90) return 1.725;
            return 1.9;
        }

        function calculateMacros() {
            const weight = parseFloat(document.getElementById('weight').value);
            const height = parseFloat(document.getElementById('height').value);
            const age = parseFloat(document.getElementById('age').value);
            const gender = document.getElementById('gender').value;
            const objective = document.getElementById('objective').value;
            const activityDays = parseFloat(document.getElementById('activity-days').value);
            const activityDuration = parseFloat(document.getElementById('activity-duration').value);
            const walking = document.getElementById('walking').value;
            const activityTime = document.getElementById('activity-time').value;
            const mealsPerDay = parseInt(document.getElementById('meals-per-day').value);

            if (isNaN(weight) || isNaN(height) || isNaN(age) || isNaN(activityDays) || isNaN(activityDuration)) {
                alert('Por favor, ingresa valores v√°lidos.');
                return;
            }

            const heightM = height / 100;
            const bmi = weight / (heightM * heightM);
            let category = '';
            if (bmi < 18.5) category = 'por debajo de lo normal';
            else if (bmi < 25) category = 'rango normal';
            else category = 'por encima de lo normal';

            const bmr = calculateBMR(weight, height, age, gender);
            const activityMultiplier = getActivityMultiplier(activityDays, activityDuration);
            const tdee = bmr * activityMultiplier;

            // Protein: 1.6-2.2, use 2 as reference
            const dailyProtein = 2 * weight;

            // Carbs: Adjusted
            let carbMultiplier;
            const isHighTraining = (activityDays >= 5 && activityDuration >= 60);
            if (objective === 'loss') {
                carbMultiplier = 2.5;
            } else if (objective === 'maintenance') {
                carbMultiplier = 4;
            } else {
                carbMultiplier = isHighTraining ? 6 : 5;
            }
            const dailyCarb = carbMultiplier * weight;

            // Fats
            let fatMultiplier;
            if (objective === 'loss') {
                fatMultiplier = 0.7;
            } else if (objective === 'maintenance') {
                fatMultiplier = 0.9;
            } else {
                fatMultiplier = 1.1;
            }
            const dailyFat = fatMultiplier * weight;

            // Fiber
            let dailyFiber;
            if (objective === 'loss') {
                dailyFiber = 35;
            } else if (objective === 'maintenance') {
                dailyFiber = 30;
            } else {
                dailyFiber = 27.5;
            }

            document.getElementById('protein').textContent = dailyProtein.toFixed(0);
            document.getElementById('carb').textContent = dailyCarb.toFixed(0);
            document.getElementById('fat').textContent = dailyFat.toFixed(0);
            document.getElementById('fiber').textContent = dailyFiber.toFixed(0);

            // User summary
            document.getElementById('user-summary').innerHTML = `
                Peso: ${weight} kg<br>
                Altura: ${height} cm<br>
                Edad: ${age} a√±os<br>
                G√©nero: ${gender === 'male' ? 'Masculino' : 'Femenino'}<br>
                Objetivo: ${objective === 'loss' ? 'P√©rdida de peso/grasa' : objective === 'maintenance' ? 'Mantenimiento' : 'Aumento de masa muscular'}<br>
                Actividad: ${activityDays} d√≠as/semana, ${activityDuration} min/sesi√≥n, hora: ${activityTime}<br>
                Caminatas: ${walking === 'yes' ? 'S√≠' : 'No'}<br>
                Comidas al d√≠a: ${mealsPerDay}<br>
                IMC: ${bmi.toFixed(1)} (${category})<br>
                BMR: ${bmr.toFixed(0)} kcal<br>
                TDEE (estimado): ${tdee.toFixed(0)} kcal
            `;

            document.getElementById('macros').style.display = 'block';
        }

        function calculateMeal() {
            const dailyProtein = parseFloat(document.getElementById('protein').textContent);
            const dailyCarb = parseFloat(document.getElementById('carb').textContent);
            const dailyFat = parseFloat(document.getElementById('fat').textContent);
            const dailyFiber = parseFloat(document.getElementById('fiber').textContent);
            const mealsPerDay = parseInt(document.getElementById('meals-per-day').value);
            const mealType = document.getElementById('meal-type').value;

            const protSource = JSON.parse(document.getElementById('protein-source').value || '{}');

            // Get selected carbs
            const selectedCarbs = [];
            for (let i = 1; i <= 2; i++) {
                const carb = document.getElementById(`carb-source${i}`).value;
                if (carb && i === 1 || carb) selectedCarbs.push(JSON.parse(carb));
            }

            const selectedFibers = [];
            for (let i = 1; i <= 2; i++) {
                const fiber = document.getElementById(`fiber-source${i}`).value;
                if (fiber && i === 1 || fiber) selectedFibers.push(JSON.parse(fiber));
            }

            const fatSource = JSON.parse(document.getElementById('fat-source').value || '{}');

            const mealProtein = dailyProtein / mealsPerDay;
            const mealCarb = dailyCarb / mealsPerDay;
            const mealFat = dailyFat / mealsPerDay;
            let mealFiber = dailyFiber / mealsPerDay;

            let protQty = (mealProtein / (protSource.prot || 1)) * (protSource.unit === '100g' ? 100 : 1);
            protQty = Math.round(protQty / 10) * 10; // Round to nearest 10
            let protDisplay = `${protQty} ${protSource.unitName}`;
            if (protSource.unit === 'unit') {
                protDisplay = `${Math.round(protQty)} ${protSource.unitName}`;
            }

            // Carbs: Primary 70%, secondary 30% if present
            let carbResult = '';
            if (selectedCarbs.length > 0) {
                const primaryPortion = selectedCarbs.length === 1 ? 1 : 0.7;
                const secondaryPortion = selectedCarbs.length > 1 ? 0.3 : 0;
                selectedCarbs.forEach((source, index) => {
                    const portion = index === 0 ? primaryPortion : secondaryPortion;
                    const sourceCarb = portion * mealCarb;
                    let qty = (sourceCarb / source.carb) * (source.unit === '100g' ? 100 : 1);
                    qty = Math.round(qty / 5) * 5; // Round to nearest 5
                    let unitDisplay = `${qty} ${source.unitName}`;
                    if (source.isFruit) {
                        const units = qty / source.avgSize;
                        const whole = Math.floor(units);
                        const half = units - whole >= 0.5 ? 0.5 : 0;
                        unitDisplay = `${whole}${half ? ' y media' : ''} ${source.unitName.split(' ')[0]}`;
                    }
                    carbResult += `${source.name}: ${unitDisplay}<br>`;
                });
            }

            let fatQty = (mealFat / (fatSource.fat || 1)) * (fatSource.unit === '100g' ? 100 : 1);
            fatQty = Math.round(fatQty / 5) * 5;

            // Fiber: Similar
            let fiberResult = '';
            if (selectedFibers.length > 0) {
                const primaryPortion = selectedFibers.length === 1 ? 1 : 0.7;
                const secondaryPortion = selectedFibers.length > 1 ? 0.3 : 0;
                selectedFibers.forEach((source, index) => {
                    const portion = index === 0 ? primaryPortion : secondaryPortion;
                    const sourceFiber = portion * mealFiber;
                    let qty = (sourceFiber / source.fiber) * (source.unit === '100g' ? 100 : 1);
                    qty = Math.round(qty / 5) * 5;
                    if (qty > 300) qty = 300;
                    if (qty < 50) qty = 50;
                    let unitDisplay = `${qty} ${source.unitName}`;
                    if (source.isFruit) {
                        const units = qty / source.avgSize;
                        const whole = Math.floor(units);
                        const half = units - whole >= 0.5 ? 0.5 : 0;
                        unitDisplay = `${whole}${half ? ' y media' : ''} ${source.unitName.split(' ')[0]}`;
                    }
                    fiberResult += `${source.name}: ${unitDisplay}<br>`;
                });
            }

            document.getElementById('meal-result').innerHTML = `
                <strong>Para esta comida (1/${mealsPerDay} del d√≠a):</strong><br>
                ${protSource.name ? `${protSource.name}: ${protDisplay}<br>` : ''}
                Carbohidratos:<br>${carbResult}
                ${fatSource.name ? `${fatSource.name}: ${fatQty} ${fatSource.unitName}<br>` : ''}
                Fibra:<br>${fiberResult}
                <em>(Cantidades redondeadas y distribuidas con m√°s peso en el principal. Pesaje en crudo.)</em>
            `;

            // Generate meal ideas based on meal type
            generateMealIdeas(mealType);
            document.getElementById('meal-ideas').style.display = 'block';
        }

        function generateMealIdeas(mealType) {
            const title = document.getElementById('ideas-title');
            const ideasList = document.getElementById('ideas-list');
            ideasList.innerHTML = '';
            let ideas = [];
            let titleText = 'Ideas de Comidas Saludables';

            if (mealType === 'breakfast') {
                titleText = 'Ideas de Desayunos Saludables';
                ideas = [
                    'Panqueques de prote√≠na: 1 porci√≥n panqueques de prote√≠na, 1 banana, 20g almendras, con caf√© o t√©.',
                    'Yogur con frutas: 150g yogur griego, 1 manzana, 30g ch√≠a, con mate cocido o leche.',
                    'Huevos con pan: 2 huevos, 50g pan integral, 30g palta, espinacas 100g, con caf√©.',
                    'Batido: 1 batido de prote√≠na, 1 banana, 20g nueces, con t√©.'
                ];
            } else if (mealType === 'snack' || mealType === 'colacion') {
                titleText = 'Ideas de Meriendas/Colaciones Saludables';
                ideas = [
                    'Barrita con fruta: 1 barrita de prote√≠na, 1 kiwi, 20g man√≠, con mate o t√©.',
                    'Yogur simple: 150g yogur griego, 100g fresas, 30g lino, con mate cocido.',
                    'Tostada: 50g pan integral, 30g mantequilla de man√≠, 1 pera, con caf√©.',
                    'Frutos secos mixtos: 30g almendras, 1 manzana, con leche.'
                ];
            } else if (mealType === 'lunch') {
                titleText = 'Ideas de Almuerzos Saludables';
                ideas = [
                    'Pollo con arroz: 150g pechuga de pollo, 100g arroz blanco, 30g palta, ensalada mixta 150g.',
                    'Pescado con papa: 100g pescado, 100g papa, 1 cda aceite, br√≥coli 200g.',
                    'Tofu con quinua: 100g tofu, 100g quinua, 20g nueces, zanahoria 150g.',
                    'Carne con pasta: 100g carne magra, 100g pasta, 50g aceitunas, pimiento 100g.'
                ];
            } else if (mealType === 'dinner') {
                titleText = 'Ideas de Cenas Saludables';
                ideas = [
                    'Salm√≥n con batata: 100g pescado, 100g batata, 30g ch√≠a, espinacas 150g.',
                    'Huevos con mandioca: 2 huevos, 100g mandioca, 20g girasol, remolacha 150g.',
                    'Cerdo con polenta: 100g carne de cerdo, 100g polenta, 30g s√©samo, coliflor 200g.',
                    'Pollo con lentejas: 150g pechuga de pollo, 50g lentejas, 1 cda aceite, pi√±a 150g como postre.'
                ];
            } else {
                titleText = 'Ideas de Comidas Saludables';
                ideas = [
                    'S√°ndwich de pechuga de pollo: 150g pechuga de pollo, 50g pan integral, 30g palta, ensalada mixta 150g.',
                    'Yogur con frutas: 150g yogur griego, 1 banana, 20g almendras, 100g fresas.',
                    'Ensalada con at√∫n: 100g at√∫n, 100g quinua, 1 cda aceite, br√≥coli 200g.',
                    'Batido post-entreno: 1 batido de prote√≠na, 100g avena, 20g ch√≠a, 1 manzana.',
                    'Cena ligera: 100g pescado, 100g papa, 50g aceitunas, espinacas 150g.',
                    'Tarta de verduras: 100g queso cottage, 100g harina de trigo, 30g nueces, zanahoria 200g y espinacas 100g.',
                    'Desayuno completo: 2 huevos, 50g pan integral, 30g mantequilla de man√≠, con mate o caf√©.',
                    'Merienda dulce: 150g yogur griego, 100g pi√±a, 30g coco rallado, con t√© o mate cocido.',
                    'Almuerzo vegetariano: 100g tofu, 100g pasta, 1 cda aceite, coliflor 200g.',
                    'Colaci√≥n r√°pida: 1 banana, 20g man√≠, con leche o infusi√≥n.'
                ];
            }

            title.textContent = titleText;
            ideas.forEach(idea => {
                const li = document.createElement('li');
                li.textContent = idea;
                ideasList.appendChild(li);
            });
        }
    </script>
</body>
</html>
