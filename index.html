<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NutriFit Guide: Tu Asistente Personal para Comidas Saludables</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            background: linear-gradient(135deg, #d4f4e2 0%, #e8f5e9 100%);
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        header {
            text-align: center;
            padding: 40px 20px;
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border-bottom-left-radius: 20px;
            border-bottom-right-radius: 20px;
        }
        h1 {
            font-size: 2.8em;
            margin: 0;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.2);
        }
        .welcome {
            font-style: italic;
            font-size: 1.2em;
            margin-top: 10px;
        }
        main {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            flex: 1;
        }
        h2, h3 {
            color: #2f855a;
            font-weight: 600;
        }
        section {
            background: white;
            padding: 30px;
            margin-bottom: 30px;
            border-radius: 15px;
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        section:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
        }
        form {
            display: grid;
            gap: 20px;
        }
        label {
            font-weight: 600;
            color: #4a5568;
            display: flex;
            align-items: center;
        }
        label::before {
            content: 'üìå ';
            margin-right: 5px;
        }
        input, select, button {
            padding: 12px;
            border: 1px solid #cbd5e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        input:focus, select:focus {
            border-color: #48bb78;
            box-shadow: 0 0 5px rgba(72,187,120,0.5);
            outline: none;
        }
        button {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            cursor: pointer;
            font-weight: 600;
            border: none;
            transition: background 0.3s, transform 0.2s;
        }
        button:hover {
            background: linear-gradient(135deg, #38a169 0%, #2f855a 100%);
            transform: scale(1.02);
        }
        #macros {
            background: #f0fff4;
            border-left: 5px solid #48bb78;
        }
        #macros p {
            margin: 10px 0;
            font-size: 1.1em;
        }
        #user-summary {
            background: #ebf8ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        #meal-result {
            margin-top: 20px;
            padding: 15px;
            background: #f0fff4;
            border-radius: 8px;
            border: 1px solid #c6f6d5;
        }
        .emoji {
            font-size: 1.2em;
            margin-right: 5px;
        }
        #flavor-choice {
            display: none;
        }
        #carb-sources, #fiber-sources {
            display: grid;
            gap: 10px;
        }
        footer {
            text-align: center;
            padding: 20px;
            color: #718096;
            font-size: 0.9em;
            background: #f7fafc;
            border-top: 1px solid #e2e8f0;
        }
        #meal-ideas {
            display: none;
        }
        #meal-ideas ul {
            list-style-type: disc;
            padding-left: 20px;
        }
    </style>
</head>
<body>
    <header>
        <h1>¬°Bienvenido a NutriFit Guide! ü•óüçé</h1>
        <p class="welcome">Tu asistente profesional para planificar comidas equilibradas, personalizadas seg√∫n tus objetivos nutricionales. ¬°Descubre opciones saludables y deliciosas!</p>
    </header>

    <main>
        <section id="user-input">
            <h2>Datos Personales üìä</h2>
            <p>Ingresa tus detalles para calcular macros precisos y personalizados. Todos los campos son requeridos para un c√°lculo √≥ptimo.</p>
            <form>
                <label>Peso (kg):</label>
                <input type="number" id="weight" required min="1">

                <label>Altura (cm):</label>
                <input type="number" id="height" required min="1">

                <label>Edad (a√±os):</label>
                <input type="number" id="age" required min="1">

                <label>G√©nero:</label>
                <select id="gender" required>
                    <option value="male">Masculino</option>
                    <option value="female">Femenino</option>
                </select>

                <label>Objetivo:</label>
                <select id="objective" required>
                    <option value="loss">P√©rdida de peso/grasa</option>
                    <option value="maintenance">Mantenimiento</option>
                    <option value="gain">Aumento de masa muscular</option>
                </select>

                <label>Nivel de Actividad F√≠sica (d√≠as por semana):</label>
                <input type="number" id="activity-days" required min="0" max="7">

                <label>Duraci√≥n por sesi√≥n (minutos):</label>
                <input type="number" id="activity-duration" required min="0">

                <label>Hora del d√≠a para actividad:</label>
                <select id="activity-time">
                    <option value="morning">Ma√±ana</option>
                    <option value="afternoon">Tarde</option>
                    <option value="evening">Noche</option>
                    <option value="any">Cualquiera</option>
                </select>

                <label>¬øRealizas caminatas?</label>
                <select id="walking" required>
                    <option value="yes">S√≠</option>
                    <option value="no">No</option>
                </select>

                <label>¬øPrefieres 4 o 5 comidas al d√≠a?</label>
                <select id="meals-per-day" required>
                    <option value="4">4 comidas</option>
                    <option value="5">5 comidas</option>
                </select>

                <button type="button" onclick="calculateMacros()">Calcular Macros Diarios</button>
            </form>
        </section>

        <section id="macros" style="display: none;">
            <h2>Resumen de Tus Datos Personales üìã</h2>
            <div id="user-summary"></div>

            <h3>Tus Macros Diarios Aproximados üçé</h3>
            <p>Basado en tus datos, aqu√≠ est√°n tus requerimientos diarios estimados. Recuerda consultar a un profesional para ajustes precisos.</p>
            <p>Prote√≠nas: <span id="protein">0</span> g</p>
            <p>Carbohidratos: <span id="carb">0</span> g</p>
            <p>Grasas Saludables: <span id="fat">0</span> g</p>
            <p>Fibra: <span id="fiber">0</span> g</p>
            <p><em>Nota: Estos c√°lculos consideran tu peso, objetivo y actividad. Usa el planificador para distribuir en comidas.</em></p>
        </section>

        <section id="meal-planner">
            <h2>Planificador de Comidas ü•ò</h2>
            <p>Selecciona el tipo de comida y personaliza tus opciones. Puedes elegir m√∫ltiples fuentes de carbohidratos y fibra; las cantidades se distribuir√°n equitativamente para cumplir con los macros. Para almuerzo o cena, incluye frutas como postre si prefieres menos ensalada. Cantidades redondeadas para facilitar el pesaje. Nota: Las cantidades se refieren a alimentos cocidos, a menos que se especifique "crudos". Para carnes y prote√≠nas, pesa crudo; para carbs como arroz o legumbres, considera el estado indicado (cocido o crudo).</p>

            <label>Tipo de Comida:</label>
            <select id="meal-type" onchange="updateFlavorChoice()">
                <option value="">Selecciona...</option>
                <option value="breakfast">Desayuno</option>
                <option value="colacion">Colaci√≥n</option>
                <option value="snack">Merienda</option>
                <option value="lunch">Almuerzo</option>
                <option value="dinner">Cena</option>
            </select>

            <div id="flavor-choice">
                <label>Preferencia:</label>
                <select id="flavor" onchange="updateOptions()">
                    <option value="salty">Salado</option>
                    <option value="sweet">Dulce</option>
                </select>
            </div>

            <label>Fuente de Prote√≠na:</label>
            <select id="protein-source"></select>

            <label>Fuentes de Carbohidrato (elige hasta 3):</label>
            <div id="carb-sources">
                <select id="carb-source1"></select>
                <select id="carb-source2" style="display: none;"></select>
                <select id="carb-source3" style="display: none;"></select>
                <button type="button" onclick="addCarbSelect()">Agregar otro carb</button>
            </div>

            <label>Fuente de Grasa Saludable:</label>
            <select id="fat-source"></select>

            <label>Fuentes de Fibra (elige hasta 3):</label>
            <div id="fiber-sources">
                <select id="fiber-source1"></select>
                <select id="fiber-source2" style="display: none;"></select>
                <select id="fiber-source3" style="display: none;"></select>
                <button type="button" onclick="addFiberSelect()">Agregar otra fibra</button>
            </div>

            <button type="button" onclick="calculateMeal()">Calcular Cantidades para esta Comida</button>

            <div id="meal-result"></div>
        </section>

        <section id="meal-ideas">
            <h2>Ideas de Comidas Saludables üçΩÔ∏è</h2>
            <p>Aqu√≠ hay algunas ideas integrando alimentos en cantidades aproximadas basadas en tus macros. Ajusta seg√∫n tus preferencias.</p>
            <ul id="ideas-list"></ul>
        </section>
    </main>

    <footer>
        ¬© 2023 NutriFit Guide | Dise√±ado para h√°bitos saludables | Consulta siempre a un nutricionista.
    </footer>

    <script>
        let carbSelectCount = 1;
        let fiberSelectCount = 1;

        // Protein sources
        const proteinSources = {
            common: [
                {name: 'Carne magra', prot: 21, unit: '100g', unitName: 'g'}, 
                {name: 'Carne de cerdo', prot: 21, unit: '100g', unitName: 'g'},
                {name: 'Pollo muslo', prot: 18, unit: '100g', unitName: 'g'}, 
                {name: 'Pechuga de pollo', prot: 22, unit: '100g', unitName: 'g'}, 
                {name: 'Huevos', prot: 6, unit: 'unit', unitName: 'huevos'},
                {name: 'Pescado (at√∫n/caballa/rio)', prot: 24, unit: '100g', unitName: 'g'},
                {name: 'Tofu', prot: 8, unit: '100g', unitName: 'g'}, // Added
                {name: 'Queso cottage', prot: 11, unit: '100g', unitName: 'g'} // Added
            ],
            breakfastSnack: [
                {name: 'Yogur griego', prot: 10, unit: '100g', unitName: 'g'}, 
                {name: 'Batido de prote√≠na', prot: 23.5, unit: 'unit', unitName: 'servings'} 
            ]
        };

        // Carb sources - Added more
        const carbSources = [
            {name: 'Arroz blanco cocido', carb: 77.5, unit: '100g', unitName: 'g', type: 'salty'},
            {name: 'Arroz integral cocido', carb: 73, unit: '100g', unitName: 'g', type: 'salty'},
            {name: 'Fideos secos', carb: 73.5, unit: '100g', unitName: 'g', type: 'salty'},
            {name: 'Avena arrollada', carb: 63, unit: '100g', unitName: 'g', type: 'both'},
            {name: 'Harina de trigo', carb: 75.5, unit: '100g', unitName: 'g', type: 'salty'},
            {name: 'Polenta', carb: 79, unit: '100g', unitName: 'g', type: 'salty'},
            {name: 'Papa cocida', carb: 18.5, unit: '100g', unitName: 'g', type: 'salty'},
            {name: 'Batata cocida', carb: 20.5, unit: '100g', unitName: 'g', type: 'salty'},
            {name: 'Mandioca cocida', carb: 39, unit: '100g', unitName: 'g', type: 'salty'},
            {name: 'Zapallo cocido', carb: 7, unit: '100g', unitName: 'g', type: 'salty'},
            {name: 'Pan blanco', carb: 49, unit: '100g', unitName: 'g', type: 'both'},
            {name: 'Pan integral', carb: 43.5, unit: '100g', unitName: 'g', type: 'both'},
            {name: 'Pan de molde', carb: 46.5, unit: '100g', unitName: 'g', type: 'both'},
            {name: 'Tortilla de trigo', carb: 52.5, unit: '100g', unitName: 'g', type: 'salty'},
            {name: 'Galletas de arroz', carb: 81, unit: '100g', unitName: 'g', type: 'salty'},
            {name: 'Banana', carb: 22.5, unit: '100g', unitName: 'g', type: 'sweet'},
            {name: 'Manzana', carb: 13.5, unit: '100g', unitName: 'g', type: 'sweet'},
            {name: 'Lentejas cocidas', carb: 20, unit: '100g', unitName: 'g', type: 'salty'},
            {name: 'Garbanzos cocidos', carb: 20, unit: '100g', unitName: 'g', type: 'salty'},
            {name: 'Porotos cocidos', carb: 20, unit: '100g', unitName: 'g', type: 'salty'},
            {name: 'Lentejas crudas', carb: 57.5, unit: '100g', unitName: 'g', type: 'salty'},
            {name: 'Garbanzos crudos', carb: 60.5, unit: '100g', unitName: 'g', type: 'salty'},
            {name: 'Porotos crudos', carb: 61, unit: '100g', unitName: 'g', type: 'salty'},
            {name: 'Quinua cocida', carb: 21, unit: '100g', unitName: 'g', type: 'salty'}, // Added
            {name: 'Pasta cocida', carb: 31, unit: '100g', unitName: 'g', type: 'salty'}, // Added
            {name: 'Ma√≠z cocido', carb: 19, unit: '100g', unitName: 'g', type: 'salty'}, // Added
            {name: 'Kiwi', carb: 15, unit: '100g', unitName: 'g', type: 'sweet'}, // Added
            {name: 'Uvas', carb: 18, unit: '100g', unitName: 'g', type: 'sweet'} // Added
        ];

        // Fat sources - Added more
        const fatSources = [
            {name: 'Aceite (1 cda ~10g grasa)', fat: 100, unit: '100g', unitName: 'g'},
            {name: 'Palta', fat: 14.5, unit: '100g', unitName: 'g'},
            {name: 'Aceitunas', fat: 12.5, unit: '100g', unitName: 'g'},
            {name: 'Almendras', fat: 49.5, unit: '100g', unitName: 'g'},
            {name: 'Nueces', fat: 65, unit: '100g', unitName: 'g'},
            {name: 'Man√≠', fat: 49, unit: '100g', unitName: 'g'},
            {name: 'Casta√±as de caj√∫', fat: 44, unit: '100g', unitName: 'g'},
            {name: 'Ch√≠a', fat: 30.5, unit: '100g', unitName: 'g'},
            {name: 'Lino', fat: 42, unit: '100g', unitName: 'g'},
            {name: 'S√©samo', fat: 49, unit: '100g', unitName: 'g'},
            {name: 'Girasol', fat: 50, unit: '100g', unitName: 'g'},
            {name: 'Mantequilla de man√≠', fat: 50, unit: '100g', unitName: 'g'}, // Added
            {name: 'Coco rallado', fat: 33, unit: '100g', unitName: 'g'} // Added
        ];

        // Fiber sources - Added more
        const fiberSources = [
            {name: 'Tomate', fiber: 1.2, unit: '100g', unitName: 'g', type: 'salty'},
            {name: 'Lechuga', fiber: 1.3, unit: '100g', unitName: 'g', type: 'salty'},
            {name: 'Br√≥coli', fiber: 2.6, unit: '100g', unitName: 'g', type: 'salty'},
            {name: 'Espinacas', fiber: 2.2, unit: '100g', unitName: 'g', type: 'salty'},
            {name: 'Zanahoria', fiber: 2.8, unit: '100g', unitName: 'g', type: 'salty'},
            {name: 'Pepino', fiber: 0.5, unit: '100g', unitName: 'g', type: 'salty'},
            {name: 'Pimiento', fiber: 1.7, unit: '100g', unitName: 'g', type: 'salty'},
            {name: 'Zapallo', fiber: 1.0, unit: '100g', unitName: 'g', type: 'salty'},
            {name: 'Ensalada mixta (lechuga + tomate + pepino)', fiber: 1.0, unit: '100g', unitName: 'g', type: 'salty'},
            {name: 'Banana (postre)', fiber: 2.6, unit: '100g', unitName: 'g', type: 'sweet'},
            {name: 'Manzana (postre)', fiber: 2.4, unit: '100g', unitName: 'g', type: 'sweet'},
            {name: 'Naranja (postre)', fiber: 2.4, unit: '100g', unitName: 'g', type: 'sweet'},
            {name: 'Fresa (postre)', fiber: 2.0, unit: '100g', unitName: 'g', type: 'sweet'},
            {name: 'Pera (postre)', fiber: 3.1, unit: '100g', unitName: 'g', type: 'sweet'},
            {name: 'Coliflor', fiber: 2.0, unit: '100g', unitName: 'g', type: 'salty'}, // Added
            {name: 'Remolacha', fiber: 2.8, unit: '100g', unitName: 'g', type: 'salty'}, // Added
            {name: 'Kiwi (postre)', fiber: 3.0, unit: '100g', unitName: 'g', type: 'sweet'}, // Added
            {name: 'Pi√±a (postre)', fiber: 1.4, unit: '100g', unitName: 'g', type: 'sweet'} // Added
        ];

        // Populate selects
        function populateSelect(select, sources) {
            select.innerHTML = '<option value="">Selecciona...</option>';
            sources.forEach(source => {
                const option = document.createElement('option');
                option.value = JSON.stringify(source);
                option.textContent = source.name;
                select.appendChild(option);
            });
        }

        populateSelect(document.getElementById('fat-source'), fatSources);

        // Add carb select
        function addCarbSelect() {
            if (carbSelectCount < 3) {
                carbSelectCount++;
                document.getElementById(`carb-source${carbSelectCount}`).style.display = 'block';
                updateOptions(); // Repopulate
            }
        }

        // Add fiber select
        function addFiberSelect() {
            if (fiberSelectCount < 3) {
                fiberSelectCount++;
                document.getElementById(`fiber-source${fiberSelectCount}`).style.display = 'block';
                updateOptions(); // Repopulate
            }
        }

        // Update flavor choice visibility
        function updateFlavorChoice() {
            const mealType = document.getElementById('meal-type').value;
            const flavorDiv = document.getElementById('flavor-choice');
            const mealsPerDay = parseInt(document.getElementById('meals-per-day').value);
            const colacionOption = document.querySelector('#meal-type option[value="colacion"]');
            if (mealsPerDay === 5) {
                if (!colacionOption) {
                    const option = document.createElement('option');
                    option.value = 'colacion';
                    option.textContent = 'Colaci√≥n';
                    document.getElementById('meal-type').appendChild(option);
                }
            } else {
                if (colacionOption) colacionOption.remove();
            }
            if (mealType === 'breakfast' || mealType === 'snack' || mealType === 'colacion') {
                flavorDiv.style.display = 'block';
            } else {
                flavorDiv.style.display = 'none';
            }
            updateOptions();
        }

        // Update options based on meal type and flavor
        function updateOptions() {
            const mealType = document.getElementById('meal-type').value;
            const flavor = document.getElementById('flavor').value || 'salty';

            // Proteins
            let proteins = proteinSources.common;
            if (mealType === 'breakfast' || mealType === 'snack' || mealType === 'colacion') {
                proteins = proteins.concat(proteinSources.breakfastSnack);
            }
            populateSelect(document.getElementById('protein-source'), proteins);

            // Carbs
            let carbFilter = carbSources;
            if (mealType === 'lunch' || mealType === 'dinner') {
                carbFilter = carbSources.filter(c => c.type === 'salty' || c.type === 'both');
            } else if (flavor === 'sweet') {
                carbFilter = carbSources.filter(c => c.type === 'sweet' || c.type === 'both');
            } else {
                carbFilter = carbSources.filter(c => c.type === 'salty' || c.type === 'both');
            }
            for (let i = 1; i <= 3; i++) {
                populateSelect(document.getElementById(`carb-source${i}`), carbFilter);
            }

            // Fiber
            let fiberFilter = fiberSources;
            if (mealType === 'lunch' || mealType === 'dinner') {
                fiberFilter = fiberSources;
            } else if (flavor === 'sweet') {
                fiberFilter = fiberSources.filter(f => f.type === 'sweet');
            } else {
                fiberFilter = fiberSources.filter(f => f.type === 'salty');
            }
            for (let i = 1; i <= 3; i++) {
                populateSelect(document.getElementById(`fiber-source${i}`), fiberFilter);
            }
        }

        function calculateBMR(weight, height, age, gender) {
            if (gender === 'male') {
                return 88.362 + (13.397 * weight) + (4.799 * height) - (5.677 * age);
            } else {
                return 447.593 + (9.247 * weight) + (3.098 * height) - (4.330 * age);
            }
        }

        function getActivityMultiplier(days, duration) {
            const intensity = (days * duration) / 7;
            if (intensity < 20) return 1.2;
            if (intensity < 40) return 1.375;
            if (intensity < 60) return 1.55;
            if (intensity < 90) return 1.725;
            return 1.9;
        }

        function calculateMacros() {
            const weight = parseFloat(document.getElementById('weight').value);
            const height = parseFloat(document.getElementById('height').value);
            const age = parseFloat(document.getElementById('age').value);
            const gender = document.getElementById('gender').value;
            const objective = document.getElementById('objective').value;
            const activityDays = parseFloat(document.getElementById('activity-days').value);
            const activityDuration = parseFloat(document.getElementById('activity-duration').value);
            const walking = document.getElementById('walking').value;
            const activityTime = document.getElementById('activity-time').value;
            const mealsPerDay = parseInt(document.getElementById('meals-per-day').value);

            if (isNaN(weight) || isNaN(height) || isNaN(age) || isNaN(activityDays) || isNaN(activityDuration)) {
                alert('Por favor, ingresa valores v√°lidos.');
                return;
            }

            const heightM = height / 100;
            const bmi = weight / (heightM * heightM);
            let category = '';
            if (bmi < 18.5) category = 'por debajo de lo normal';
            else if (bmi < 25) category = 'rango normal';
            else category = 'por encima de lo normal';

            const bmr = calculateBMR(weight, height, age, gender);
            const activityMultiplier = getActivityMultiplier(activityDays, activityDuration);
            const tdee = bmr * activityMultiplier;

            // Protein: Use 2 g/kg as reference
            const dailyProtein = 2 * weight;

            // Carbs: Adjusted ranges
            let carbMultiplier;
            const isHighTraining = (activityDays >= 5 && activityDuration >= 60);
            if (objective === 'loss') {
                carbMultiplier = 2.5; // Midpoint 2-3
            } else if (objective === 'maintenance') {
                carbMultiplier = 4; // Midpoint 3-5
            } else {
                carbMultiplier = isHighTraining ? 6 : 5; // 5-7, higher for much training
            }
            const dailyCarb = carbMultiplier * weight;

            // Fats: Keep previous, but can adjust if needed
            let fatMultiplier;
            if (objective === 'loss') {
                fatMultiplier = 0.7;
            } else if (objective === 'maintenance') {
                fatMultiplier = 0.9;
            } else {
                fatMultiplier = 1.1;
            }
            const dailyFat = fatMultiplier * weight;

            // Fiber
            let dailyFiber;
            if (objective === 'loss') {
                dailyFiber = 35;
            } else if (objective === 'maintenance') {
                dailyFiber = 30;
            } else {
                dailyFiber = 27.5;
            }

            document.getElementById('protein').textContent = dailyProtein.toFixed(0);
            document.getElementById('carb').textContent = dailyCarb.toFixed(0);
            document.getElementById('fat').textContent = dailyFat.toFixed(0);
            document.getElementById('fiber').textContent = dailyFiber.toFixed(0);

            // User summary
            document.getElementById('user-summary').innerHTML = `
                Peso: ${weight} kg<br>
                Altura: ${height} cm<br>
                Edad: ${age} a√±os<br>
                G√©nero: ${gender === 'male' ? 'Masculino' : 'Femenino'}<br>
                Objetivo: ${objective === 'loss' ? 'P√©rdida de peso/grasa' : objective === 'maintenance' ? 'Mantenimiento' : 'Aumento de masa muscular'}<br>
                Actividad: ${activityDays} d√≠as/semana, ${activityDuration} min/sesi√≥n, hora: ${activityTime}<br>
                Caminatas: ${walking === 'yes' ? 'S√≠' : 'No'}<br>
                Comidas al d√≠a: ${mealsPerDay}<br>
                IMC: ${bmi.toFixed(1)} (${category})<br>
                BMR: ${bmr.toFixed(0)} kcal<br>
                TDEE (estimado): ${tdee.toFixed(0)} kcal
            `;

            document.getElementById('macros').style.display = 'block';
        }

        function calculateMeal() {
            const dailyProtein = parseFloat(document.getElementById('protein').textContent);
            const dailyCarb = parseFloat(document.getElementById('carb').textContent);
            const dailyFat = parseFloat(document.getElementById('fat').textContent);
            const dailyFiber = parseFloat(document.getElementById('fiber').textContent);
            const mealsPerDay = parseInt(document.getElementById('meals-per-day').value);

            const protSource = JSON.parse(document.getElementById('protein-source').value || '{}');

            // Get selected carbs
            const selectedCarbs = [];
            for (let i = 1; i <= carbSelectCount; i++) {
                const carb = document.getElementById(`carb-source${i}`).value;
                if (carb) selectedCarbs.push(JSON.parse(carb));
            }

            const selectedFibers = [];
            for (let i = 1; i <= fiberSelectCount; i++) {
                const fiber = document.getElementById(`fiber-source${i}`).value;
                if (fiber) selectedFibers.push(JSON.parse(fiber));
            }

            const fatSource = JSON.parse(document.getElementById('fat-source').value || '{}');

            const mealProtein = dailyProtein / mealsPerDay;
            const mealCarb = dailyCarb / mealsPerDay;
            const mealFat = dailyFat / mealsPerDay;
            let mealFiber = dailyFiber / mealsPerDay;

            const protQty = Math.round((mealProtein / (protSource.prot || 1)) * (protSource.unit === '100g' ? 100 : 1));

            // Carbs: Divide mealCarb equally among selected
            let carbResult = '';
            if (selectedCarbs.length > 0) {
                const carbPerSource = mealCarb / selectedCarbs.length;
                selectedCarbs.forEach(source => {
                    const qty = Math.round((carbPerSource / source.carb) * (source.unit === '100g' ? 100 : 1));
                    carbResult += `${source.name}: ${qty} ${source.unitName}<br>`;
                });
            }

            const fatQty = Math.round((mealFat / (fatSource.fat || 1)) * (fatSource.unit === '100g' ? 100 : 1));

            // Fiber: Divide mealFiber equally, cap 300g per source
            let fiberResult = '';
            if (selectedFibers.length > 0) {
                const fiberPerSource = mealFiber / selectedFibers.length;
                selectedFibers.forEach(source => {
                    let qty = Math.round((fiberPerSource / source.fiber) * (source.unit === '100g' ? 100 : 1));
                    if (qty > 300) qty = 300;
                    if (qty < 100) qty = 100;
                    fiberResult += `${source.name}: ${qty} ${source.unitName}<br>`;
                });
            }

            document.getElementById('meal-result').innerHTML = `
                <strong>Para esta comida (1/${mealsPerDay} del d√≠a):</strong><br>
                ${protSource.name ? `${protSource.name}: ${protQty} ${protSource.unitName} (pesa crudo)<br>` : ''}
                Carbohidratos:<br>${carbResult}
                ${fatSource.name ? `${fatSource.name}: ${fatQty} ${fatSource.unitName}<br>` : ''}
                Fibra:<br>${fiberResult}
                <em>(Cantidades redondeadas y distribuidas equitativamente. Ajusta si necesitas.)</em>
            `;

            // Generate meal ideas
            generateMealIdeas(mealProtein, mealCarb, mealFat, mealFiber);
            document.getElementById('meal-ideas').style.display = 'block';
        }

        function generateMealIdeas(protein, carb, fat, fiber) {
            const ideasList = document.getElementById('ideas-list');
            ideasList.innerHTML = '';
            const ideas = [
                `S√°ndwich de pechuga de pollo: 100g pechuga (22g prot), 50g pan integral (22g carb), 30g palta (4g grasa), ensalada mixta 150g (~2g fibra). Total approx: prot ${protein.toFixed(0)/4}, carb ${carb.toFixed(0)/4}, etc.`,
                `Yogur con frutas: 150g yogur griego (15g prot), 100g banana (23g carb), 20g almendras (10g grasa), 100g fresas (2g fibra).`,
                `Ensalada con at√∫n: 100g at√∫n (24g prot), 100g quinua (21g carb), 1 cda aceite (10g grasa), br√≥coli 200g (5g fibra).`,
                `Batido post-entreno: Batido prote√≠na (24g prot), 100g avena (63g carb), 20g ch√≠a (6g grasa), manzana 100g (2g fibra).`,
                `Cena ligera: 100g salm√≥n (20g prot, added more prot sources but using existing), 100g papa (19g carb), 50g aceitunas (6g grasa), espinacas 150g (3g fibra).`
            ];
            ideas.forEach(idea => {
                const li = document.createElement('li');
                li.textContent = idea;
                ideasList.appendChild(li);
            });
        }
    </script>
</body>
</html>
